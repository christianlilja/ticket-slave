{% extends "base.html" %}
{% block content %}
<div id="flash-container"></div>
<h2>Settings</h2>

<!-- Tab navigation -->
<ul class="nav nav-tabs" id="settingsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">General</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab">Email Server</button>
  </li>
</ul>

<form method="POST" class="mt-3">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <div class="tab-content" id="settingsTabsContent">

    <!-- General Settings Tab -->
    <div class="tab-pane fade show active" id="general" role="tabpanel">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="allow_registration" id="allow_registration" {% if settings['allow_registration'] == '1' %}checked{% endif %}>
        <label class="form-check-label" for="allow_registration">Allow new users to register</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="enable_api" id="enable_api" {% if settings['enable_api'] == '1' %}checked{% endif %}>
        <label class="form-check-label" for="enable_api">Enable API</label>
      </div>
    </div>

    <!-- Email Settings Tab -->
    <div class="tab-pane fade" id="email" role="tabpanel">
      <div class="mb-3 mt-3">
        <label for="smtp_server" class="form-label">SMTP Server</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="smtp_use_tls" id="smtp_use_tls" {% if settings['smtp_use_tls'] == '1' %}checked{% endif %}>
          <label class="form-check-label" for="smtp_use_tls">Use TLS</label>
          </div>
          <div style="margin-top: 20px;">
        <input type="text" class="form-control" name="smtp_server" value="{{ settings['smtp_server'] }}">
      </div>
      <div class="mb-3">
        <label for="smtp_port" class="form-label">SMTP Port</label>
        <input type="text" class="form-control" name="smtp_port" value="{{ settings['smtp_port'] }}">
      </div>
      <div class="mb-3">
        <label for="smtp_from_email" class="form-label">From Email</label>
        <input type="email" class="form-control" name="smtp_from_email" value="{{ settings['smtp_from_email'] }}">
      </div>
      <div class="mb-3">
        <label for="smtp_username" class="form-label">SMTP Username</label>
        <input type="text" class="form-control" name="smtp_username" value="{{ settings['smtp_username'] }}">
      </div>
      <div class="mb-3">
        <label for="smtp_password" class="form-label">SMTP Password</label>
        <input type="password" class="form-control" name="smtp_password" value="{{ settings['smtp_password'] }}">
      </div>
        <div style="margin-bottom: 30px;"></div>
        <button type="button" id="test-email-btn" class="btn btn-outline-info mt-2">
          Test Email Settings
        </button>
      </div>
  </div>
  <div style="margin-bottom: 50px;"></div>
  <div class="d-flex gap-2">
    <button type="submit" name="action" value="save_settings" class="btn btn-primary">
      Save Settings
    </button>
  </div>
</form>
<script>
const csrfToken = '{{ csrf_token() if csrf_token else "" }}';
  document.getElementById('test-email-btn').addEventListener('click', function () {
    fetch('/settings/test-email', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      const flashContainer = document.getElementById('flash-container');
      if (flashContainer) {
        const div = document.createElement('div');
        div.className = `alert alert-${data.category || 'info'} mt-3`;
        div.textContent = data.message;
        flashContainer.appendChild(div);
      }
    })
    .catch(err => console.error('Error testing email:', err));
  });
  </script>
{% endblock %}
